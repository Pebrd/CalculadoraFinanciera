<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores Financieros de Argentina - Gráficos Históricos</title>

    <link rel="stylesheet" href="shared-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="shared-scripts.js"></script>
    <style>
        /* === ESTILOS ESPECÍFICOS DE GRÁFICOS === */

        header {
            background-color: #111;
            color: var(--base);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }


        main {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        section {
            /* Estilo de sección plano y oscuro */
            background-color: #050505;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #111;
        }

        h2 {
            color: var(--base);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .chart-container {
            position: relative;
            /* Altura fija para escritorio */
            height: 400px;
            width: 100%;
            margin: 0 auto;
        }

        /* Estilos para los botones de filtro */
        .filter-buttons {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .filter-buttons button {
            /* === MODIFICACIONES DE COLOR AQUÍ === */
            padding: 8px 15px;
            border: 1px solid var(--button-border-color); /* Gris oscuro */
            background-color: #000;
            color: var(--button-text-color); /* Gris claro */
            /* ==================================== */

            border-radius: 0;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .filter-buttons button:hover,
        .filter-buttons button.active {
            /* === MODIFICACIONES DE COLOR AQUÍ === */
            background-color: var(--button-active-bg); /* Gris un poco más claro para hover/active */
            color: var(--base); /* Texto color base (blanco/gris claro) */
            /* ==================================== */
        }

        footer {
            padding: 15px;
            background-color: #111;
            color: #999;
            margin-top: 30px;
        }

        /* === OPTIMIZACIÓN MÓVIL (Max-width: 600px) === */
        @media (max-width: 600px) {

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.3rem;
            }

            /* 1. Altura del gráfico reducida para caber mejor en la pantalla */
            .chart-container {
                height: 300px;
            }

            /* 2. Navegación: Corrección para mostrar en dos columnas sin desbordar */
            nav {
                width: 100%;
                flex-wrap: wrap;
                padding: 5px 0;
                margin: 0 auto 30px auto;
            }
            nav a {
                flex: 1 1 calc(50% - 10px);
                box-sizing: border-box;
                padding: 8px 5px;
                font-size: 0.9rem;
                margin: 5px 2px;
            }

            /* 3. Botones de Filtro: Los apila verticalmente */
            .filter-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .filter-buttons button {
                width: 100%;
                padding: 10px 5px;
                font-size: 1rem;
            }
        }

        /* === ESTILOS PARA LOS BLOQUES IPC y RIESGO PAÍS (Dos Columnas) === */
        :root {
          --base:#ccc;
          --texto:#ddd;
          --error:#f44;
        }

        /* Contenedor Flex para que se muestren uno al lado del otro */
        .data-container {
            max-width: 900px;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* Estilos de los bloques de datos (IPC y Riesgo País) */
        #inflacion-section,
        #riesgo-section {
            width: 440px;
            max-width: 50%;
            flex-grow: 1;
            min-width: 300px;

            background:#050505;
            border:1px solid #111;
            padding:10px;
            font-size:0.9rem;
            box-sizing:border-box;
            display: flex;
            flex-direction: column;
        }

        .data-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }
        .data-grid {
            display:flex;
            justify-content:space-around;
            flex-wrap:wrap;
            gap:10px;
            flex-grow: 1;
            align-items: center;
        }

        .data-item {
            text-align:center;
            min-width:100px;
            font-size: 1.1rem;
            padding: 5px;
        }
        /* Estilo específico del valor grande (el número/porcentaje) */
        #inflacion-section .data-item span,
        #riesgo-section .data-item span {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--base);
            display: block;
            margin-top: 5px;
        }

        #last-inflacion, #last-riesgo {
            font-size:0.75rem;
            color:#777;
            text-align:right;
            margin-top:5px;
        }
        .fuente {
            text-align:right;
            font-size:0.7rem;
            color:#666;
            margin-top:4px;
        }
        .error {
            color:var(--error);
            font-size:0.8rem;
            text-align:right;
            margin-top:4px;
        }

        /* Media Query para asegurar el apilamiento en móvil cuando el espacio es menor a 640px */
        @media (max-width: 640px) {
            .data-container {
                flex-direction: column;
                align-items: center;
            }
            #inflacion-section,
            #riesgo-section {
                width: 95%;
                max-width: 95%;
            }
             /* Ajuste de tamaño para móvil para que no sea excesivamente grande */
            #inflacion-section .data-item span,
            #riesgo-section .data-item span {
                font-size: 1.8rem;
            }
            .data-item {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Indicadores Financieros de Argentina 🚀</h1>
        <p>Visualización de Inflación Mensual, Interanual y Riesgo País.</p>
    </header>

    <div class="data-container">
        <section id="inflacion-section">
            <div class="data-header"><strong>📈 IPC </strong></div>
            <div class="data-grid">
                <div class="data-item">Mensual<br><span id="inflacion-mensual">--</span></div>
                <div class="data-item">Período<br><span id="inflacion-mes">--</span></div>
            </div>
            <div id="last-inflacion">Esperando actualización...</div>
            <div class="fuente">Fuente: argentinadatos.com</div>
        </section>

        <section id="riesgo-section">
            <div class="data-header"><strong>📊 Riesgo País</strong></div>
            <div class="data-grid">
                <div class="data-item">Último valor<br><span id="riesgo-valor">--</span></div>
                <div class="data-item">Fecha<br><span id="riesgo-fecha">--</span></div>
            </div>
            <div id="last-riesgo">Esperando actualización...</div>
            <div class="fuente">Fuente: argentinadatos.com</div>
        </section>
    </div>
    <main>
        <section id="interanual-section">
            <h2>Inflación Interanual (%) - Últimos 12 meses</h2>
            <div class="chart-container">
                <canvas id="chartInflacionAnual"></canvas>
            </div>
        </section>

        <section>
            <h2>Inflación Mensual - Nivel General (%)</h2>
            <div class="filter-buttons" data-chart-id="chartInflacionMensual" data-raw-data-key="inflacionMensual">
                <button class="active" data-period="1">Último Año</button>
                <button data-period="5">Últimos 5 Años</button>
                <button data-period="0">Total</button>
            </div>
            <div class="chart-container">
                <canvas id="chartInflacionMensual"></canvas>
            </div>
        </section>

        <section>
            <h2>Riesgo País (Puntos Básicos)</h2>
            <div class="filter-buttons" data-chart-id="chartRiesgoPais" data-raw-data-key="riesgoPais">
                <button class="active" data-period="1">Último Año</button>
                <button data-period="5">Últimos 5 Años</button>
                <button data-period="0">Total</button>
            </div>
            <div class="chart-container">
                <canvas id="chartRiesgoPais"></canvas>
            </div>
        </section>
    </main>

    <footer>
        <p>Datos obtenidos de ArgentinaDatos API.</p>
    </footer>

    <script>
        /* === SCRIPT PARA CARGAR INFLACIÓN Y RIESGO PAÍS (EJECUCIÓN INMEDIATA) === */
        async function cargarInflacion() {
          const last = document.getElementById("last-inflacion");
          try {
            const res = await fetch("https://api.argentinadatos.com/v1/finanzas/indices/inflacion");
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) { throw new Error("Sin datos"); }

            const ult = data[data.length - 1];
            const valor = parseFloat(String(ult.valor).replace(",", "."));
            const fecha = new Date(ult.fecha);
            const mes = fecha.toLocaleString("es-AR", { month: "long", year: "numeric" });

            document.getElementById("inflacion-mensual").textContent = isNaN(valor) ? "-" : valor.toFixed(2) + "%";
            document.getElementById("inflacion-mes").textContent = mes;
            last.textContent = "Actualizado: " + new Date().toLocaleTimeString("es-AR", { hour: "2-digit", minute: "2-digit", hour12: false });
          } catch (err) {
            console.error("Error al obtener inflación:", err);
            last.innerHTML = '<span class="error">Error al cargar inflación</span>';
            document.getElementById("inflacion-mensual").textContent = "-";
            document.getElementById("inflacion-mes").textContent = "--";
          }
        }
        cargarInflacion();

        async function cargarRiesgo(){
          const last=document.getElementById("last-riesgo");
          try{
            const res=await fetch("https://api.argentinadatos.com/v1/finanzas/indices/riesgo-pais/ultimo");
            const ult=await res.json();
            document.getElementById("riesgo-valor").textContent=ult.valor+" pts";
            document.getElementById("riesgo-fecha").textContent=ult.fecha;
            last.textContent="Actualizado: "+new Date().toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
          }catch(e){last.innerHTML='<span class="error">Error al cargar riesgo país</span>';}
        }
        cargarRiesgo();
        /* === FIN SCRIPTS ADICIONALES === */

        document.addEventListener('DOMContentLoaded', () => {

            const BASE_URL = 'https://api.argentinadatos.com/v1/finanzas/indices/';
            const RAW_DATA_STORE = {};
            const CHART_INSTANCES = {};

            // --- Funciones Auxiliares ---

            function parseDateForChart(dateString) {
                if (!dateString) return null;
                // Formato ISO 8601 (YYYY-MM-DD)
                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateString;
                }
                return null;
            }

            async function fetchData(endpoint) {
                try {
                    const url = `${BASE_URL}${endpoint}`;
                    const response = await axios.get(url);
                    return response.data || [];
                } catch (error) {
                    console.error(`ERROR al obtener datos de ${endpoint}:`, error);
                    return [];
                }
            }

            function filterDataByPeriod(data, years) {
                if (years === 0) {
                    return data;
                }

                const currentDate = new Date();
                const targetDate = new Date();
                targetDate.setFullYear(currentDate.getFullYear() - years);

                let startIndex = 0;
                for (let i = 0; i < data.length; i++) {
                    if (new Date(data[i].x) >= targetDate) {
                        startIndex = i;
                        break;
                    }
                }

                return data.slice(startIndex);
            }

            function createOrUpdateChart(canvasId, title, data, borderColor, dateUnit) {
                let canvas = document.getElementById(canvasId);

                if (data.length === 0) {
                    if (CHART_INSTANCES[canvasId]) {
                        CHART_INSTANCES[canvasId].destroy();
                        delete CHART_INSTANCES[canvasId];
                    }
                    console.log(`No hay datos para el gráfico: ${title}`);
                    return;
                }

                if (!canvas || !canvas.getContext) {
                    const targetContainer = document.querySelector(`#${canvasId}`).parentNode;
                    targetContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                    canvas = document.getElementById(canvasId);
                }

                const ctx = canvas.getContext('2d');
                const yAxisTitle = (canvasId === 'chartRiesgoPais' ? 'Valor' : 'Valor (%)');
                const pointRadiusValue = (canvasId === 'chartInflacionAnual' ? 2 : 0);


                if (CHART_INSTANCES[canvasId]) {
                    // 1. Actualizar gráfico existente
                    CHART_INSTANCES[canvasId].data.datasets[0].data = data;
                    CHART_INSTANCES[canvasId].options.scales.y.title.text = yAxisTitle;
                    CHART_INSTANCES[canvasId].data.datasets[0].label = title;
                    CHART_INSTANCES[canvasId].data.datasets[0].pointRadius = pointRadiusValue;
                    CHART_INSTANCES[canvasId].update();
                } else {
                    // 2. Crear nuevo gráfico
                    const newChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: title,
                                data: data,
                                borderColor: borderColor,
                                backgroundColor: `${borderColor}30`,
                                tension: 0.2,
                                fill: false,
                                pointRadius: pointRadiusValue,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true },
                                tooltip: { mode: 'index', intersect: false },
                                decimation: { enabled: true, algorithm: 'min-max' }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: dateUnit,
                                        tooltipFormat: dateUnit === 'day' ? 'dd/MM/yyyy' : 'MM/yyyy'
                                    },
                                    title: { display: true, text: 'Fecha' }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: yAxisTitle },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                }
                            }
                        }
                    });
                    CHART_INSTANCES[canvasId] = newChart;
                }
            }

            // ----------------------------------------------------------------------
            // --- GRÁFICO 1: Inflación Interanual ---
            // ----------------------------------------------------------------------

            async function plotInflacionInteranual() {
                const dataRaw = await fetchData('inflacionInteranual');
                if (dataRaw.length === 0) return;

                const annualDataChart = dataRaw
                    .map(item => ({
                        x: parseDateForChart(item.fecha),
                        y: item.valor
                    }))
                    .filter(item => item.x !== null && item.y !== undefined)
                    .sort((a, b) => new Date(a.x) - new Date(b.x));

                if (annualDataChart.length === 0) return;

                RAW_DATA_STORE.inflacionInteranual = annualDataChart;
                // Mostrar solo los últimos 12 meses para el gráfico inicial
                const annualFinalData = annualDataChart.slice(-12);

                createOrUpdateChart(
                    'chartInflacionAnual',
                    'Inflación Interanual (%)',
                    annualFinalData,
                    'rgb(255, 99, 132)',
                    'month'
                );
            }

            // ----------------------------------------------------------------------
            // --- GRÁFICO 2: Inflación Mensual ---
            // ----------------------------------------------------------------------

            async function plotInflacionMensual() {
                const dataRaw = await fetchData('inflacion');
                if (dataRaw.length === 0) return;

                const monthlyDataChart = dataRaw
                    .map(item => ({
                        x: parseDateForChart(item.fecha),
                        y: item.valor
                    }))
                    .filter(item => item.x !== null && item.y !== undefined)
                    .sort((a, b) => new Date(a.x) - new Date(b.x));

                if (monthlyDataChart.length === 0) return;

                RAW_DATA_STORE.inflacionMensual = monthlyDataChart;
                const monthlyFinalData = filterDataByPeriod(monthlyDataChart, 1);

                createOrUpdateChart(
                    'chartInflacionMensual',
                    'Inflación Mensual - Nivel General (%)',
                    monthlyFinalData,
                    'rgb(54, 162, 235)',
                    'month'
                );
            }

            // ----------------------------------------------------------------------
            // --- GRÁFICO 3: Riesgo País ---
            // ----------------------------------------------------------------------

            async function plotRiesgoPais() {
                const dataRaw = await fetchData('riesgo-pais');
                if (dataRaw.length === 0) return;

                const dataChart = dataRaw
                    .map(item => ({
                        x: parseDateForChart(item.fecha),
                        y: item.valor
                    }))
                    .filter(item => item.x !== null && item.y !== undefined)
                    .sort((a, b) => new Date(a.x) - new Date(b.x));

                if (dataChart.length === 0) return;

                RAW_DATA_STORE.riesgoPais = dataChart;
                const finalData = filterDataByPeriod(dataChart, 1);

                createOrUpdateChart(
                    'chartRiesgoPais',
                    'Riesgo País (Puntos Básicos)',
                    finalData,
                    'rgb(75, 192, 192)',
                    'day'
                );
            }

            // ----------------------------------------------------------------------
            // --- Lógica de Interacción de Botones ---
            // ----------------------------------------------------------------------

            function handleFilterClick(event) {
                const button = event.target;
                if (button.tagName !== 'BUTTON') return;

                const container = button.closest('.filter-buttons');
                const chartId = container.dataset.chartId;
                const rawDataKey = container.dataset.rawDataKey;
                const period = parseInt(button.dataset.period);

                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const rawData = RAW_DATA_STORE[rawDataKey];
                if (!rawData) return;

                const filteredData = filterDataByPeriod(rawData, period);

                let title, borderColor, dateUnit;
                if (chartId === 'chartInflacionMensual') {
                    title = 'Inflación Mensual - Nivel General (%)';
                    borderColor = 'rgb(54, 162, 235)';
                    dateUnit = 'month';
                } else if (chartId === 'chartRiesgoPais') {
                    title = 'Riesgo País (Puntos Básicos)';
                    borderColor = 'rgb(75, 192, 192)';
                    dateUnit = 'day';
                } else {
                    return;
                }

                createOrUpdateChart(
                    chartId,
                    title,
                    filteredData,
                    borderColor,
                    dateUnit
                );
            }

            document.querySelectorAll('.filter-buttons').forEach(container => {
                container.addEventListener('click', handleFilterClick);
            });

            // Ejecutar la carga de datos y gráficos iniciales
            plotInflacionInteranual();
            plotInflacionMensual();
            plotRiesgoPais();
        });
    </script>
    <script src="modern-navigation.js"></script>
</body>
</html>
