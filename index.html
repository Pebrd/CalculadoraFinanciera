<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cotizaciones Bancarias y Cripto</title>
<style>
/* === ESTILOS GLOBALES === */
:root {
  --base:#ccc;
  --gris:#111;
  --texto:#ddd;
  --borde:#ccc40;
  --error:#f44;
  --destacado-compra: rgba(40, 167, 69, 0.4); /* Green tint */
  --destacado-venta: rgba(0, 123, 255, 0.4); /* Blue tint */
}
body {
  background:#000;
  color:var(--texto);
  font-family:'Courier New', monospace;
  margin:0;
  padding:20px;
}
h1 {
  text-align:center;
  color:var(--base);
  font-size:2rem;
  margin-bottom:20px;
  text-shadow:0 0 8px rgba(204,204,204,0.6);
}
/* --- Navegaci贸n --- */
nav {
    max-width: 900px;
    margin: 0 auto 30px auto;
    text-align: center;
    padding: 10px 0;
    border-bottom: 1px solid #222;
    display: flex; 
    justify-content: center; 
    flex-wrap: wrap; /* CAMBIO CLAVE: Permite que los links salten de l铆nea en m贸vil */
}
nav a {
    color: var(--base);
    text-decoration: none;
    font-size: 1.1rem;
    padding: 8px 15px;
    margin: 0 5px;
    transition: background-color 0.3s;
    border: 1px solid transparent;
}
nav a.active {
    border-color: var(--base);
    background: rgba(204, 204, 204, 0.1);
}
nav a:hover:not(.active) {
    background: #111;
}

/* --- SECCIONES DE TABLAS NUEVAS (Bancos y USDT) Y EL NUEVO BLOQUE DE DLAR --- */
/* Esta clase define el ancho y el centrado (900px max-width, margin: 0 auto) */
.table-block-container {
    max-width: 900px;
    margin: 0 auto 40px auto;
}
.new-table-container {
    background: #050505;
    border: 1px solid #111;
    padding: 15px;
    border-radius: 0;
    margin-bottom: 20px;
    box-sizing: border-box;
}
.table-block-container h2 {
    color: var(--base);
    text-align: center;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.5rem;
}

/* --- BANNERS DE RESUMEN (APLICADO A USD Y USDT) --- */
.summary-banner {
    background: #111;
    border-left: 5px solid #333;
    padding: 10px;
    box-shadow: none;
    display: flex;
    justify-content: space-around;
    gap: 15px;
    margin-bottom: 15px;
}
.best-buy {
    background-color: var(--destacado-compra);
    border-left: 5px solid #4f4;
}
.best-sell {
    background-color: var(--destacado-venta);
    border-left: 5px solid #007bff;
}
.best-deal {
    padding: 10px; border-radius: 4px; text-align: center; flex: 1;
}
.best-deal h3 {
    color: var(--base);
    font-size: 1em;
    margin: 0 0 5px 0;
}
.best-deal p {
    color: var(--texto);
    font-size: 1.2em; font-weight: bold; margin: 0;
}

.controls button {
    background-color: #333 !important;
    color: var(--base) !important;
    padding:6px 10px;
    border:1px solid #444;
    cursor:pointer;
}
#last-updated, .last-update {
    color: #777;
    font-size: 0.8em;
}

/* --- Tablas (General) --- */
.table-scroll-container, .table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #333;
    border-radius: 0;
}
#quotation-table, .price-table {
    width: 100%;
    border-collapse: collapse;
}
#quotation-table th, .price-table th, 
#quotation-table td, .price-table td {
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid #222;
    background-color: #000;
}
#quotation-table th, .price-table th {
    background-color: #111 !important;
    color: var(--base) !important;
    cursor: pointer;
}
#quotation-table tbody tr:nth-child(even) {
    background-color: #050505;
}
/* Resaltado de mejores ofertas */
.highlight-best-buy, .price-table .best-buy-cell {
    background-color: var(--destacado-compra) !important;
    color: #fff !important;
}
.highlight-best-sell, .price-table .best-sell-cell {
    background-color: var(--destacado-venta) !important;
    color: #fff !important;
}

/* --- Estado de APIs --- */
#api-status {
  max-width: 900px;
  margin: 40px auto 0 auto;
  padding: 5px 20px;
  background: #050505;
  border: 1px solid #111;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 25px;
  box-sizing: border-box;
}
.api-indicator {
  padding: 0;
  border: none;
  box-shadow: none;
  display: flex;
  align-items: center;
  margin: 0 15px;
}
.api-indicator strong {
  display: inline;
  font-size: 0.8rem;
  margin-bottom: 0;
  color: #777;
  margin-right: 5px;
}
.status-light {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 5px;
  vertical-align: middle;
}
.status-light.funcional {
  background-color: #4f4;
  box-shadow: 0 0 8px #4f4;
}
.status-light.error {
  background-color: var(--error);
  box-shadow: 0 0 8px var(--error);
}
.status-text {
  font-weight: normal;
  font-size: 0.8rem;
  vertical-align: middle;
}

/* === ESTILOS ESPECFICOS DEL NUEVO BLOQUE DE COTIZACIONES DLAR === */
/* Se unific贸 el contenedor principal con .table-block-container */
.data-section {
  background:#050505;
  border:1px solid #111;
  padding:10px;
  margin:0;
  font-size:0.9rem;
  box-sizing:border-box;
  display: flex;
  flex-direction: column;
  height: 100%;
}
.data-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.data-grid {
  display:flex;
  justify-content:space-around;
  flex-wrap:wrap;
  gap:10px;
  flex-grow: 1;
  align-items: center;
}
.data-item {
  text-align:center;
  min-width:100px;
}
#reload-btn {
  background:#111;
  color:#ccc;
  border:1px solid #333;
  padding:4px 8px;
  cursor:pointer;
  font-size:0.8rem;
}
#reload-btn:hover { background:#222; }
#last-update { 
  font-size:0.75rem;
  color:#777;
  text-align:right;
  margin-top:5px;
}
.fuente {
  text-align:right;
  font-size:0.7rem;
  color:#666;
  margin-top:4px;
}
.error {
  color:var(--error);
  font-size:0.8rem;
  text-align:right;
  margin-top:4px;
}
/* --- Estilo espec铆fico para los valores del d贸lar --- */
#dolar-section .data-item span {
  font-size: 0.9rem;
}

/* Media Query para m贸vil (Existente y modificado) */
@media (max-width: 600px) {
    /* 1. Fix: Navegaci贸n */
    nav {
        justify-content: space-around; /* Mejor distribuci贸n para elementos que saltan de l铆nea */
        padding: 10px;
    }
    nav a {
        padding: 8px 5px;
        font-size: 0.9rem;
        margin: 4px 2px; /* Separaci贸n vertical y horizontal */
        flex-basis: 45%; /* Dos elementos por l铆nea, usando casi la mitad del espacio */
        box-sizing: border-box; 
    }
    /* 2. Fix: Botones de Actualizaci贸n y Hora */
    .table-block-container .controls {
        flex-direction: column; 
        align-items: flex-start;
        gap: 5px;
    }
    .table-block-container .controls button {
        width: 100%; 
        padding: 8px !important; 
        font-size: 1rem;
    }
    #last-updated-usd, #last-update-time-usdt {
        align-self: flex-start; 
        font-size: 0.8em;
    }
    /* Estilos API Status existente */
    #api-status {
        height: auto;
        flex-direction: column;
        padding: 8px 10px;
    }
    .api-indicator {
        margin: 3px 0;
        justify-content: center;
    }
    /* Asegurar que el bot贸n de recarga del nuevo bloque se vea bien en m贸vil */
    #dolar-section .data-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    #dolar-section #reload-btn {
        width: 100%;
        padding: 8px !important; 
        font-size: 1rem;
    }
    #dolar-section strong {
        font-size: 1.1rem;
    }
}
</style>
</head>
<body>
<nav>
    <a href="index.html" class="active">Cotizaciones</a>
    <a href="calculadoras.html">Calculadoras</a>
    <a href="tasas.html">TNA</a>
    <a href="noticias.html">Noticias</a>
    <a href="Graficos historicos.html">Gr谩ficos</a>
    <a href="Hacienda.html">Agro</a>
    <a href="ScreenerArgy.html">Argy</a>
</nav>
<h1>Cotizaciones Bancarias y Cripto</h1>

<div class="table-block-container new-table-container">
  <section class="data-section" id="dolar-section">
    <div class="data-header">
      <strong> Cotizaciones del d贸lar</strong>
      <button id="reload-btn">Recargar</button>
    </div>
    <div class="data-grid">
      <div class="data-item" id="oficial">Oficial<br><span>--</span></div>
      <div class="data-item" id="blue">Blue<br><span>--</span></div>
      <div class="data-item" id="mep">MEP<br><span>--</span></div>
      <div class="data-item" id="ccl">CCL<br><span>--</span></div>
      <div class="data-item" id="cripto">Cripto<br><span>--</span></div>
    </div>
    <div id="last-update">Esperando actualizaci贸n...</div>
    <div class="fuente">Fuente: dolarapi.com</div>
  </section>
</div>
<div class="table-block-container new-table-container">
    <h2> D贸lar (USD/ARS) Bancos</h2>

    <div id="summary-banner-usd" class="summary-banner" >
        <div class="best-deal best-buy" id="best-buy-deal-usd">
            <h3> Mejor Compra (Ask m谩s bajo)</h3>
            <p id="best-buy-info-usd">Cargando...</p>
        </div>
        <div class="best-deal best-sell" id="best-sell-deal-usd">
            <h3> Mejor Venta (Bid m谩s alto)</h3>
            <p id="best-sell-info-usd">Cargando...</p>
        </div>
    </div>

    <div class="controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button id="refresh-button-usd"> Actualizar Ahora</button>
        <span id="last-updated-usd">ltima actualizaci贸n: --:--:--</span>
    </div>

    <div class="table-container">
        <table id="quotation-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Entidad</th>
                    <th id="sort-ask" class="sortable">Compra (Ask)</th>
                    <th id="sort-bid" class="sortable">Venta (Bid)</th>
                </tr>
            </thead>
            <tbody id="quotation-body-usd">
                <tr><td colspan="3">Cargando cotizaciones...</td></tr>
            </tbody>
        </table>
    </div>

    <p class="footer" style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #666;">Datos provistos por CriptoYa - Actualizaci贸n autom谩tica cada 5 minutos.</p>
</div>

<div class="table-block-container new-table-container">
    <h2> Cotizaci贸n de Compra/Venta USDT/ARS</h2>

    <div id="summary-banner-usdt" class="summary-banner" >
        <div class="best-deal best-buy" id="best-buy-deal-usdt">
            <h3> Compras m谩s Barata (Ask)</h3>
            <p id="best-buy-info-usdt">Cargando...</p>
        </div>
        <div class="best-deal best-sell" id="best-sell-deal-usdt">
            <h3> Vendes m谩s Cara (Bid)</h3>
            <p id="best-sell-info-usdt">Cargando...</p>
        </div>
    </div>

    <div class="controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <button class="update-button" id="manual-update-button-usdt"> Actualizar Precios</button>
        <span class="last-update" id="last-update-time-usdt">ltima actualizaci贸n: Cargando...</span>
    </div>

    <div class="table-scroll-container">
        <table class="price-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Exchange</th>
                    <th class="sortable" data-sort-by="ask">Compra (Ask)</th>
                    <th class="sortable" data-sort-by="bid">Venta (Bid)</th>
                </tr>
            </thead>
            <tbody id="price-table-body-usdt">
                <tr><td colspan="3">Cargando cotizaciones...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="api-status">
  <div class="api-indicator">
    <strong>DolarAPI.com:</strong>
    <span id="dolarapi-status">
      <span class="status-light"></span>
      <span class="status-text">Cargando...</span>
    </span>
  </div>
  <div class="api-indicator">
    <strong>ArgentinaDatos.com:</strong>
    <span id="argentinadatos-status">
      <span class="status-light"></span>
      <span class="status-text">Cargando...</span>
    </span>
  </div>
  <div class="api-indicator">
    <strong>CriptoYa.com:</strong>
    <span id="criptoya-status">
      <span class="status-light"></span>
      <span class="status-text">Cargando...</span>
    </span>
  </div>
</div>

<script>
/* ========================================================== */
/* === SCRIPT para cargar solo las cotizaciones del D贸lar (MODIFICADO) === */
async function cargarDolares(){
 const last=document.getElementById("last-update");
  const reloadBtn = document.getElementById("reload-btn");
  if (reloadBtn) {
    reloadBtn.disabled = true;
    reloadBtn.textContent = 'Cargando...';
  }
  
 try{
  const res=await fetch("https://dolarapi.com/v1/dolares");
  const data=await res.json();
  const map={
   oficial:data.find(d=>d.nombre.toLowerCase().includes("oficial")),
   blue:data.find(d=>d.nombre.toLowerCase().includes("blue")),
   mep:data.find(d=>d.nombre.toLowerCase().includes("bolsa")),
   ccl:data.find(d=>d.nombre.toLowerCase().includes("contado con liqui")),
   cripto:data.find(d=>d.nombre.toLowerCase().includes("cripto"))
  };
  Object.entries(map).forEach(([k,v])=>{
   const el=document.querySelector(`#${k} span`);
   if(v&&el){el.textContent=`C: ${v.compra.toFixed(2)} | V: ${v.venta.toFixed(2)}`;}
   else if(el){el.textContent="N/D";}
  });
  last.textContent="Actualizado: "+new Date().toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
 }catch(e){
    last.innerHTML='<span class="error">Error al cargar cotizaciones</span>';
    console.error("Error al cargar cotizaciones de DolarAPI:", e);
  } finally {
      if (reloadBtn) {
          reloadBtn.disabled = false;
          reloadBtn.textContent = 'Recargar';
      }
  }
}
document.addEventListener('DOMContentLoaded', () => {
    // Solo si el elemento existe (el nuevo bloque fue insertado)
    const reloadBtn = document.getElementById("reload-btn");
    if (reloadBtn) {
        reloadBtn.addEventListener("click", cargarDolares);
        cargarDolares();
    }
});
/* Se quitan las funciones cargarInflacion() y cargarRiesgo() */

/* ========================================================== */
/* === SCRIPT 1: TABLA BANCOS USD/ARS (Sin cambios) === */
/* ========================================================== */
(function() {
    const API_URL = 'https://criptoya.com/api/bancostodos';
    const TABLE_BODY = document.getElementById('quotation-body-usd');
    const LAST_UPDATED_SPAN = document.getElementById('last-updated-usd');
    const REFRESH_BUTTON = document.getElementById('refresh-button-usd');
    const BEST_BUY_INFO = document.getElementById('best-buy-info-usd');
    const BEST_SELL_INFO = document.getElementById('best-sell-info-usd');

    let currentSort = { column: 'ask', direction: 1 };

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2, }).format(value);
    };

    const processData = (rawData) => {
        const cleanedData = [];
        for (const [entityName, prices] of Object.entries(rawData)) {
            const ask = prices.ask;
            const bid = prices.bid;
            const isValid = (value) => value !== null && value !== 0 && typeof value === 'number' && !isNaN(value);
            if (isValid(ask) && isValid(bid)) { cleanedData.push({ entity: entityName, ask: ask, bid: bid, }); }
        }
        return cleanedData;
    };

    const applySort = (data, column, direction) => {
        return [...data].sort((a, b) => {
            if (a[column] < b[column]) return -1 * direction;
            if (a[column] > b[column]) return 1 * direction;
            return 0;
        });
    };

    const initialSort = (data) => {
        if (data.length === 0) return [];
        const bestAskValue = Math.min(...data.map(item => item.ask));
        const bestBidValue = Math.max(...data.map(item => item.bid));
        const highlights = [];
        const rest = [];
        const highlightEntities = new Set();
        data.forEach(item => {
            const isBestAsk = item.ask === bestAskValue;
            const isBestBid = item.bid === bestBidValue;
            if (isBestAsk || isBestBid) {
                if (!highlightEntities.has(item.entity)) {
                    highlights.push(item);
                    highlightEntities.add(item.entity);
                }
            } else {
                rest.push(item);
            }
        });
        rest.sort((a, b) => b.bid - a.bid); 
        return [...highlights, ...rest];
    };

    const updateSummaryBanner = (data) => {
        const buyDeal = document.getElementById('best-buy-deal-usd');
        const sellDeal = document.getElementById('best-sell-deal-usd');
        
        if (data.length === 0) {
            BEST_BUY_INFO.textContent = 'No hay datos v谩lidos.';
            BEST_SELL_INFO.textContent = 'No hay datos v谩lidos.';
            buyDeal.className = 'best-deal summary-banner';
            sellDeal.className = 'best-deal summary-banner';
            return;
        }

        const bestAsk = data.reduce((min, curr) => (!min || curr.ask < min.ask) ? curr : min, null);
        const bestBid = data.reduce((max, curr) => (!max || curr.bid > max.bid) ? curr : max, null);

        if (bestAsk) {
            BEST_BUY_INFO.innerHTML = `${bestAsk.entity}: <br>${formatCurrency(bestAsk.ask)}`;
            buyDeal.className = 'best-deal best-buy';
        }
        if (bestBid) {
            BEST_SELL_INFO.innerHTML = `${bestBid.entity}: <br>${formatCurrency(bestBid.bid)}`;
            sellDeal.className = 'best-deal best-sell';
        }
    };

    const renderTable = (data) => {
        TABLE_BODY.innerHTML = '';
        if (data.length === 0) {
            TABLE_BODY.innerHTML = '<tr><td colspan="3" style="color: var(--error); text-align:center;">No hay cotizaciones v谩lidas para mostrar.</td></tr>';
            return;
        }

        const bestAskValue = Math.min(...data.map(item => item.ask));
        const bestBidValue = Math.max(...data.map(item => item.bid));

        data.forEach(item => {
            const row = TABLE_BODY.insertRow();
            const isBestAsk = item.ask === bestAskValue;
            const isBestBid = item.bid === bestBidValue;
            
            const entityCell = row.insertCell();
            entityCell.textContent = item.entity;
            entityCell.style.textAlign = 'left';

            const askCell = row.insertCell();
            askCell.textContent = formatCurrency(item.ask);
            if (isBestAsk) { askCell.classList.add('highlight-best-buy'); }

            const bidCell = row.insertCell();
            bidCell.textContent = formatCurrency(item.bid);
            if (isBestBid) { bidCell.classList.add('highlight-best-sell'); }
        });

        LAST_UPDATED_SPAN.textContent = `ltima actualizaci贸n: ${new Date().toLocaleTimeString('es-AR')}`;
    };

    const fetchDataAndRender = async (isInitialLoad = false) => {
        REFRESH_BUTTON.disabled = true;
        REFRESH_BUTTON.textContent = 'Cargando...';

        try {
            const response = await fetch(API_URL);
            if (!response.ok) { throw new Error(`Error en la API: ${response.statusText}`); }
            const rawData = await response.json();
            const processed = processData(rawData);
            updateSummaryBanner(processed);

            let dataToShow;
            if (isInitialLoad) {
                dataToShow = initialSort(processed);
                currentSort = { column: 'ask', direction: 1 };
            } else {
                dataToShow = applySort(processed, currentSort.column, currentSort.direction);
            }
            renderTable(dataToShow);
        } catch (error) {
            console.error('Error al obtener o procesar datos USD:', error);
            TABLE_BODY.innerHTML = `<tr><td colspan="3" style="color: var(--error); text-align:center;">Error al cargar los datos.</td></tr>`;
            BEST_BUY_INFO.textContent = 'Error de carga.';
            BEST_SELL_INFO.textContent = 'Error de carga.';
            document.getElementById('best-buy-deal-usd').className = 'best-deal summary-banner';
            document.getElementById('best-sell-deal-usd').className = 'best-deal summary-banner';
        } finally {
            REFRESH_BUTTON.disabled = false;
            REFRESH_BUTTON.textContent = ' Actualizar Ahora';
        }
    };

    const handleSortClick = async (column) => {
        let newDirection;
        if (currentSort.column === column) { newDirection = currentSort.direction * -1; } 
        else { newDirection = (column === 'ask') ? 1 : -1; }
        currentSort = { column: column, direction: newDirection };
        
        // Re-fetch para garantizar datos frescos antes de ordenar
        const response = await fetch(API_URL);
        const data = processData(await response.json()); 

        renderTable(applySort(data, currentSort.column, currentSort.direction));
    };

    document.addEventListener('DOMContentLoaded', () => {
        fetchDataAndRender(true);
        REFRESH_BUTTON.addEventListener('click', () => fetchDataAndRender(false));
        document.getElementById('sort-ask').addEventListener('click', () => handleSortClick('ask'));
        document.getElementById('sort-bid').addEventListener('click', () => handleSortClick('bid'));
        const FIVE_MINUTES = 5 * 60 * 1000;
        setInterval(() => fetchDataAndRender(false), FIVE_MINUTES);
    });
})();

/* ========================================================== */
/* === SCRIPT 2: TABLA USDT/ARS (Sin cambios) === */
/* ========================================================== */
(function() {
    const API_URL = 'https://criptoya.com/api/usdt/ars/0.1';
    const tableBody = document.getElementById('price-table-body-usdt');
    const sortableHeaders = document.querySelectorAll('.price-table .sortable');
    const updateButton = document.getElementById('manual-update-button-usdt');
    const lastUpdateTimeSpan = document.getElementById('last-update-time-usdt');
    const BEST_BUY_INFO = document.getElementById('best-buy-info-usdt');
    const BEST_SELL_INFO = document.getElementById('best-sell-info-usdt');
    const AUTO_UPDATE_INTERVAL = 300000; 

    let allExchangeData = [];
    let bestPrices = {};
    let currentSort = { column: null, direction: null };
    
    // UTILS
    function capitalize(s) {
        if (typeof s !== 'string' || s.length === 0) return '';
        return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
    }
    function formatPrice(price) {
        return price.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2, });
    }

    function updateLastUpdateTime(date) {
        const timeString = date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        lastUpdateTimeSpan.textContent = `ltima actualizaci贸n: ${timeString}`;
    }

    function processData(data) {
        const processed = [];
        for (const [exchange, values] of Object.entries(data)) {
            // Filtrar y limpiar datos
            if (values.ask && values.ask > 0 && values.bid && values.bid > 0) {
                processed.push({
                    exchange: capitalize(exchange),
                    ask: parseFloat(values.ask),
                    bid: parseFloat(values.bid)
                });
            }
        }
        return processed;
    }

    function findBestPrices(data) {
        let bestBuy = data.reduce((min, item) => (item.ask < min.price ? { exchange: item.exchange, price: item.ask } : min), { exchange: '', price: Infinity });
        let bestSell = data.reduce((max, item) => (item.bid > max.price ? { exchange: item.exchange, price: item.bid } : max), { exchange: '', price: -Infinity });
        return { bestBuy, bestSell };
    }

    function updateSummaryBanner() {
        const buyDeal = document.getElementById('best-buy-deal-usdt');
        const sellDeal = document.getElementById('best-sell-deal-usdt');

        if (!bestPrices.bestBuy || bestPrices.bestBuy.price === Infinity) {
            BEST_BUY_INFO.textContent = 'No hay datos v谩lidos.';
            BEST_SELL_INFO.textContent = 'No hay datos v谩lidos.';
            buyDeal.className = 'best-deal summary-banner';
            sellDeal.className = 'best-deal summary-banner';
            return;
        }

        const buyPrice = formatPrice(bestPrices.bestBuy.price);
        const sellPrice = formatPrice(bestPrices.bestSell.price);

        BEST_BUY_INFO.innerHTML = `${bestPrices.bestBuy.exchange}: <br>${buyPrice}`;
        buyDeal.className = 'best-deal best-buy';

        BEST_SELL_INFO.innerHTML = `${bestPrices.bestSell.exchange}: <br>${sellPrice}`;
        sellDeal.className = 'best-deal best-sell';
    }

    function renderTable(data) {
        tableBody.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" style="color: var(--error); text-align:center;">No hay cotizaciones v谩lidas para mostrar.</td></tr>';
            return;
        }

        data.forEach(item => {
            const row = tableBody.insertRow();
            
            const exchangeCell = row.insertCell();
            exchangeCell.textContent = item.exchange;
            exchangeCell.style.textAlign = 'left';

            const askCell = row.insertCell();
            askCell.textContent = formatPrice(item.ask);
            if (item.exchange === bestPrices.bestBuy.exchange) { askCell.classList.add('best-buy-cell'); }

            const bidCell = row.insertCell();
            bidCell.textContent = formatPrice(item.bid);
            if (item.exchange === bestPrices.bestSell.exchange) { bidCell.classList.add('best-sell-cell'); }
        });
    }

    // SORTING LOGIC
    function initialDataPresentation() {
        const bestBuyExchange = bestPrices.bestBuy.exchange;
        const bestSellExchange = bestPrices.bestSell.exchange;
        const bestBuyItem = allExchangeData.find(item => item.exchange === bestBuyExchange);
        const bestSellItem = allExchangeData.find(item => item.exchange === bestSellExchange);
        const restOfData = allExchangeData.filter(item =>
            item.exchange !== bestBuyExchange && item.exchange !== bestSellExchange
        );
        restOfData.sort((a, b) => b.bid - a.bid);
        let finalPresentationData = [];
        if (bestBuyItem) { finalPresentationData.push(bestBuyItem); }
        if (bestSellItem && bestBuyExchange !== bestSellExchange) { finalPresentationData.push(bestSellItem); }
        finalPresentationData = finalPresentationData.concat(restOfData);
        renderTable(finalPresentationData);
    }

    function applySorting(column, direction) {
        const sortedData = [...allExchangeData].sort((a, b) => {
            let comparison = 0;
            if (a[column] > b[column]) { comparison = 1; } 
            else if (a[column] < b[column]) { comparison = -1; }
            return direction === 'desc' ? comparison * -1 : comparison;
        });

        currentSort = { column, direction };
        renderTable(sortedData);
    }

    function handleHeaderClick() {
        const column = this.dataset.sortBy;
        let direction = 'asc';

        if (currentSort.column === column) {
            direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            direction = column === 'ask' ? 'asc' : 'desc';
        }
        applySorting(column, direction);
    }

    // MAIN FETCH
    async function fetchPrices() {
        updateButton.disabled = true;
        updateButton.textContent = ' Cargando...';
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const data = await response.json();
            allExchangeData = processData(data);
            if (allExchangeData.length === 0) { throw new Error("No se recibieron datos de cotizaci贸n v谩lidos."); }
            bestPrices = findBestPrices(allExchangeData);
            updateSummaryBanner();

            if (currentSort.column === null) { initialDataPresentation(); } 
            else { applySorting(currentSort.column, currentSort.direction); }

            updateLastUpdateTime(new Date());

        } catch (error) {
            console.error("Error al obtener o procesar la cotizaci贸n USDT:", error);
            BEST_BUY_INFO.textContent = 'Error de carga.';
            BEST_SELL_INFO.textContent = 'Error de carga.';
            document.getElementById('best-buy-deal-usdt').className = 'best-deal summary-banner';
            document.getElementById('best-sell-deal-usdt').className = 'best-deal summary-banner';
            tableBody.innerHTML = `<tr><td colspan="3" style="color:var(--error); text-align:center;">锔 Error al cargar los datos.</td></tr>`;
        } finally {
            updateButton.disabled = false;
            updateButton.textContent = ' Actualizar Precios';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchPrices();
        updateButton.addEventListener('click', fetchPrices);
        sortableHeaders.forEach(header => { header.addEventListener('click', handleHeaderClick); });
        setInterval(fetchPrices, AUTO_UPDATE_INTERVAL);
    });
})();

/* ========================================================== */
/* === SCRIPT 3: MONITOREO DE ESTADO DE APIS (Sin cambios) === */
/* ========================================================== */
async function checkApiStatus(url, elementId) {
  const statusElement = document.getElementById(elementId);
  const light = statusElement.querySelector('.status-light');
  const text = statusElement.querySelector('.status-text');

  light.className = 'status-light';
  text.textContent = 'Cargando...';
  text.style.color = '#ddd';

  try {
    const response = await fetch(url);
    const data = await response.json();

    // L贸gica simplificada que el usuario indic贸 que funciona para DolarAPI y ArgentinaDatos.
    // Se utiliza para todas las APIs para mantener el c贸digo unificado.
    const isUp = (data.status === "ok" || data.status === "available" || response.ok);

    if (isUp) {
      light.className = 'status-light funcional';
      text.textContent = 'Funcional';
      text.style.color = '#4f4';
    } else {
      light.className = 'status-light error';
      text.textContent = 'Error';
      text.style.color = 'var(--error)';
    }
  } catch (e) {
    light.className = 'status-light error';
    text.textContent = 'Error';
    text.style.color = 'var(--error)';
    console.error(`Error al verificar estado de API ${elementId}:`, e);
  }
}

function loadApiStatus() {
  checkApiStatus("https://dolarapi.com/v1/estado", "dolarapi-status");
  checkApiStatus("https://api.argentinadatos.com/v1/estado", "argentinadatos-status");
  checkApiStatus("https://criptoya.com/api/dolar", "criptoya-status"); 
}

loadApiStatus();
setInterval(loadApiStatus, 3600000); 
</script>
</body>
</html>
